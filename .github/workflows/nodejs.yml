# .github/workflows/nodejs.yml

on: # è§¦å‘æ­¤æ–‡ä»¶è¿è¡Œçš„æ¡ä»¶
  workflow_dispatch: # æ‰‹åŠ¨
  push: # push æ—¶

name: CI/CD # æ­¤å·¥ä½œæµç¨‹ï¼ˆworkflowï¼‰çš„åå­—
jobs:
  FTP-Deploy-Action:
    name: CI&CD # æ­¤ä»»åŠ¡ï¼ˆjobï¼‰çš„åå­—
    runs-on: ubuntu-24.04 # è¿è¡Œç¯å¢ƒ
    steps:
      - uses: actions/checkout@v4 # åˆ‡æ¢åˆ†æ”¯
        with:
          fetch-depth: 2

      - name: Use Node.js 16
        uses: actions/setup-node@v4 # ä½¿ç”¨nodeç¯å¢ƒ
        with:
          node-version: 16 # ç‰ˆæœ¬16

      - name: Cache node modules
        id: cache # ç¼“å­˜id
        uses: actions/cache@v4
        env:
          cache-name: cache-node-modules # ç¼“å­˜åå­—
        with:
          path: node_modules # ç¼“å­˜è·¯å¾„
          key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('package.json') }} # ç¼“å­˜æ ‡è¯†

      - name: Install Dependencies
        if: steps.cache.outputs.cache-hit != 'true' # å¦‚æœæ²¡æœ‰ç¼“å­˜çš„è¯
        run: npm install # å®‰è£…ä¾èµ–

      - name: Build project
        run: npm run docs:build # æ„å»ºé¡¹ç›®å’Œç”Ÿæˆä»£ç è¦†ç›–ç‡æŠ¥å‘Š
        env:
          LEANCLOUD_APP_ID: ${{ secrets.LEANCLOUD_APP_ID }} # è¯„ è®ºç³»ç»Ÿçš„ID
          LEANCLOUD_APP_KEY: ${{ secrets.LEANCLOUD_APP_KEY }} # è¯„è®ºç³»ç»Ÿçš„KEY

      # å¦‚æœFTP-Deploy-Actionå‡ºç°ï¼ŒDirty repository: Having uncommitted changes. é—®é¢˜æ—¶ï¼Œä½¿ç”¨ä»¥ä¸‹æ³¨é‡Šæ­¥éª¤è§£å†³é—®é¢˜
      - name: reset git
        run: git reset --hard

      - name: ğŸ“‚ Sync files
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_IP }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: docs/.vuepress/dist/ # é€‰æ‹©å“ªäº›æ–‡ä»¶è¦éƒ¨ç½²åˆ°æœåŠ¡å™¨ï¼Œè¿™ä¸ªé€‰é¡¹åœ¨è¿™é‡Œé€‰äº†ä¹‹åï¼Œè¦åœ¨.git-ftp-includeä¸­æ·»åŠ ç›¸åº”çš„è·¯å¾„
          server-dir: /

#           ftp-server: sftp://${{ secrets.FTP_IP }}/home/www/htdocs # æœåŠ¡å™¨åœ°å€å’Œç«¯å£ï¼ˆå¯ä»¥å¡«åŸŸåï¼Œä¸è¿‡æˆ‘æœåŠ¡å™¨åšäº†å…¨ç«™åŠ é€Ÿä¼šå¯¼å‘åŠ é€Ÿç»“ç‚¹çš„IPï¼Œæ‰€ä»¥åªèƒ½ç”¨æœåŠ¡å™¨çš„IPï¼‰
#           ftp-username: ${{ secrets.FTP_USERNAME }} # FTPç”¨æˆ·å
#           ftp-password: ${{ secrets.FTP_PASSWORD }} # FTPå¯†ç 
#           git-ftp-args: --insecure # ï¼ˆå¦‚æœæ˜¯FTPè¿æ¥çš„è¯--insecureä¸ç”¨åŠ ï¼‰
#           local-dir: docs/.vuepress/dist/ # é€‰æ‹©å“ªäº›æ–‡ä»¶è¦éƒ¨ç½²åˆ°æœåŠ¡å™¨ï¼Œè¿™ä¸ªé€‰é¡¹åœ¨è¿™é‡Œé€‰äº†ä¹‹åï¼Œè¦åœ¨.git-ftp-includeä¸­æ·»åŠ ç›¸åº”çš„è·¯å¾„

      - name: upload-artifact
        uses: actions/upload-artifact@v4 #å…±äº«æˆ–ä¿å­˜actionè¿‡ç¨‹ä¸­äº§ç”Ÿçš„æ–‡ä»¶
        with:
          name: static_web_file
          path: ./docs/.vuepress/dist/ # or path/to/artifact
